## 区块链基础技术

区块链技术通过建立一个共同维护且不可被篡改的数据库来记录过滤的所有交易记录和历史数据，所有的数据都是分布式存储且公开透明的。在这种技术下，任何互不认识的网络用户都可以通过合约、点对点对账、数字加密等方式达成信用共识，而不需要任何的中央信用机构。在这种技术下，我们可以建立数字货币、数字资产、智能财产以及智能合约等。

本章中，我们将继续讨论区块链的技术细节。

##  区块链技术
区块链本质上市一个对等网络（peer-to-peer）的分布式账本数据库。比特币的底层就采用了区块链的技术架构。区块链本身其实是一串链接的数据区块，其链接指针是采用密码学哈希算法对区块头进行处理所产生的区块头哈希值。每一个数据块中记录了一组采用嘻哈算法组成的树状交易状态信息，这样保证了每个区块内的交易数据不可篡改，区块链里链接的区块也不可篡改。

### 基本概念

一个完整的区块链系统包含了很多技术，其中有存储数据的数据区块及其之上的数字签名、时间戳等技术，有作为支撑的P2P网络和维护系统的共识算法，有挖矿和工作量证明机制，还匿名交易机制和比特币钱包，还有链龄、UTXO、Merkle树、双花等相关技术概念。正是这些技术，使得区块链在无中心的网络上形成运转不息的引擎，为区块链的交易、验证、链接等功能提供了源源不断的动力。

**1.数据区块**

比特币的交易记录会保存在数据区块之中，比特币系统中大约每10分钟会产生一个区块，每个数据区块一般包含区块头（Header）和区块体（Body）两部分
![images](https://github.com/WangBeijing/webBlog/blob/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/images/1181538392512.jpg?raw=true)
区块结构

区块头封装了当前的版本号（Version）、前一区块地址（Prevblock）、时间戳、随机数（Nonce）、Merkle树的根值（Merkle-root）等信息

区块体中则主要包含交易计数和交易详情。交易详情就是比特币系统中的记账本，每一笔交易都会被永久地记入数据区块中，而且任何人都可以查询。区块体中的Merkle树将会对每一笔交易进行数字签名，如此可以确保每一笔交易都不可伪造且没有重复交易。所有交易都通过Merkle树的Hash过程产生一个唯一Merkle根值记入区块头。

如果你使用的是比特币核心钱包（Bitcoin core），那么每当你打开客户端时，区块数据文件都会被同步到电脑硬盘中，可以在blocks文件夹下找到。

**2.挖矿与分叉问题**

区块在挖矿过程中产生。所谓挖矿，实际上是穷举随机数算法，把上个区块的哈希值加上10分钟内的全部交易单打包，再加上一个随机数，算出一个256位的字符串哈希值，输入的随机数Nonc使哈希值满足一定条件就获得这个区块的交易记账权。每个区块存着上一个区块的哈希值，可以溯源到源头，只有经过验证后才最终获得区块的交易记账权。所有的区块链接在一起形成了区块链的主链，从创始区块到当前区块，在区块链之上的所有数据历史都可以被追溯和查询.

当主链分叉以后，后续区块的矿工将通过计算和比较，将其区块链接到当前累计工作量证明最大化的备选链上，形成更长的新主链，并自动抛弃分叉处的短链，从而解决分叉问题。

**3.时间戳和不可篡改性**

时间戳是指从格林威治时间1970年01月01日00时00分00秒起至现在的总毫秒数，通常是一个字符序列，唯一地标识某一刻的时间。在比特币系统，获得记账权的节点在链接区块时需要在区块头中加盖时间戳，用于记录当前区块数据的写入时间。每一个随后区块中的时间戳都会对前一个时间戳进行增强，形成一个时间递增的链条。时间戳技术本身没有多复杂，但是在区块链技术中应用时间戳却是一个重大创新，时间戳为未来基于区块链的互联网和大数据增加了一个时间维度，使得数据更容易追溯。同时，时间戳可以作为存在性证明（Proof of Existence）的重要参数，它能够证实特定数据必然在某特定时刻是的确存在的，这保证了区块链数据库是不可篡改和不可伪造的，这也为区块链技术应用于公证、知识产权注册等时间敏感领域提供了可能。

**4.分布式数据库**

比特币系统中的区块就像一个记账本一样，记录了所有比特币的交易信息，每个比特币用户的比特币的交易信息，每一个比特币用户的比特币收支情况都被永久地嵌入数据区块中以供别人查询。任何一个节点的数据被破坏都不会影响整个数据库的正常运转，因为其他的健康节点中都保存了完整的数据库

**5.UTXO交易模式**

UTXO是未花费的交易输出，它是比特币交易过程中的基本单位。当前整个区块链网络中UTXO会被储存在每个节点中，只有满足了来源于UTXO和数字签名条件的交易才是合法。所以区块链系统中的新交易并不需要追溯整个交易历史，就可以确认当前交易是否合法.

**6.哈希函数**

区块链中的数据并不只是原始数据或者交易记录，还包括它们的原始数据或者交易记录，还包括它们的哈希函数值，即将原始数据编码为特定长度的、由数字和字母组成的字符串后，记入区块链。

哈希函数有着很多适合存储区块链数据的优点：
- 1）哈希函数处理过得数据是单向性的，通过处理过的输出值几乎不可能计算出原始的输入值
- 2）哈希函数处理不同长度的数据所耗费的时间是一致的，输出值也是定长的
- 3）哈希函数的输入值即使只相差一个字节，输出值的结果也会迥然不同。

哈希函数是比特币系统的关键技术，为比特币系统提供了很多便利。

**7.Merkle树**

Merkle树是数据结构中的一种树，可能是二叉树，也可能是多叉树，它具有树结构的所有特点。
![image](https://github.com/WangBeijing/webBlog/blob/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/images/1201538394730.jpg?raw=true)

**8.双重支付**

双重支付问题又称为“双花”问题，即利用货币的数字特性用‘同一笔钱’完成两次或者多次支付。区块链技术则在去中心化的系统中不借助任何第三方机构而只通过分布式节点之间的相互验证和共识机制，有效地解决了双重支付问题，在信息传递的同时完成了价值转移。区块链技术通过区块链接形成的时间戳技术加上验证比特币是否满足UTXO（未花费交易）和数字签名，有效避免了双重支付问题。在比特币区块链上，6次确认后可以基本保证比特币不被双花

**9.P2P网络**

P2P网络（peer-to-peer network，对等网络）是一种在对等者（peer）之间分配任务和工作负载的分布式应用架构，是对等计算模型在应用层形成的一种组网或网络形式。因此，从字面上，P2P可以理解为对等计算或对等网络，P2P网络示意图如图2-5所示。国内的迅雷软件采用的就是P2P技术。区块链系统是建立在IP通信协议和分布式网络的基础上的，它不依靠传统
的电路交换，而是建立于网络通信之上，完全通过互联网去交换信息。网络中所有的节点具有同等的地位，不存在任何特殊化的中心节点和层级结构，每个节点均会承担网络路由、验证数据区块等功能。网络的节点根据存储数据量的不同可以分为全节点和轻量级节点，全节点存储了从创世区块以来的所有区块链数据（比特币网络现在大约有几十GB，且还在不断增长中）。全节点的优点是进行数据校验时不需要依靠别的节点，仅依靠自身就可以完成校验更新等操作，缺点是硬件成本较高。轻量级节点只需要存储部分数据信息，当需要别的数据时可以通过简易支付验证方式（Simplif ied Payment Verif ication, SPV）向邻近节点请求所需数据来完成验证更新。

![images](https://github.com/WangBeijing/webBlog/blob/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/images/1231538395527.jpg?raw=true)

**10.加密算法**

除了哈希算法以外，比特币中还存在一种为交易加密的非对称加密算法（椭圆曲线加密算法）。非对称加密算法指的就是存在一对数学相关的密钥，使用其中一个密钥进行加密数据信息，只有使用另一个密钥才能对该信息进行解密。这对密钥中，对外公开的密钥叫公钥，不公开的密钥叫私钥。
![images](https://github.com/WangBeijing/webBlog/blob/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/images/1241538395775.jpg?raw=true)

**11.数字签名**
数字签名就是在信息后面加上另一对内容，作为发送者的证明并且证明信息没有被篡改。一般是发送者将信息用哈希算法处理得出一个哈希值，然后用私钥对该哈希值进行加密，得出一个签名。接受者使用发送者的公钥对掐你名进行解密，还原出哈希值，再通过哈希算法来验证信息的哈希值和解密签名还原出来的哈希值是否一致，从而可以鉴定信息是否来自发送者或者信息是否被篡改。

**12.比特币的隐私模型**

## 框架与特点

#### 1.框架介绍
目前大多数的区块链技术的应用于比特币类似，大部分是在比特币架构基础上的扩展。
![images](https://github.com/WangBeijing/webBlog/blob/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/images/1251538396114.jpg?raw=true)

首先在网络层之上，区块链是建在IP通信协议和对等网络的基础上的一个分布式系统，和传统带中心的分布式系统不一样，它不依靠中心化的服务器节点来转发消息，而是每一个节点都参与消息的转发。因此P2P网络比传统网络具有更高的安全性，任何一个节点被攻击都不会影响整个网络，所有的节点都保存着整个系统的状态信息。

其次，在数据层面上，区块链就是一个只可追加、不可更改的分布式数据库系统，是一个分布式账本。如果是公开的区块链，也就是公有链，那么这个账本可以被任何人在任何地方进行查询，完全公开透明。在区块链网络中，节点通过使用共识算法来维持网络中账本数据库的一致性。同时采用密码学的签名和哈希算法来确保这个数据库不可篡改，不能作伪，并且可追溯。例如，在比特币系统中，只有在控制了51%的网络算力时才有可能对区块链进行重组以修改账本信息。由于比特币系统的设计者中本聪在系统设计中巧妙地加入了带有经济激励的挖矿工作量证明（PoW）机制，使得即使拥有网络51%以上算力的人也不会损害其自身利益而发起对网络的攻击。因此，比特币系统自上线7年多来一直持续不断地正常运行，没有出现过因为比特币系统本身缺陷而造成的安全故障。

再次，在应用层面，我们可以用区块链代替传统的登记、清算系统在应用方面，区块链平台能够提供编程环境让用户编写智能合约。通过智能合约，可以把业务规则转化成在区块链平台自动执行的合约，该合约的执行不依赖可信任的第三方，也不受人为的干预。理论上只要一旦部署，一旦符合合约执行的条件就会自动执行。执行结果也可以在区块链上供公开检查，提供了合约的公正性和透明性。因此，智能合约可以降低合约建立、执行和仲裁中

所涉及的中间机构成本。区块链的智能合约奠定了未来建立可编程货币、可编程金融，甚至是可编程社会的基础

#### 2.架构特点
区块链具有去中心化、可靠数据库、开源可编程、集体维护、安全可信、交易准匿名性等特点。

区块链技术的核心优势是去中心化，能够通过运用哈希算法、数字签名、时间戳、分布式共识和经济激励等手段，在节点无需互相信任的分布式系统中建立信用，实现点对点交易和协作，从而为中心化机构普遍存在的高成本、低效率和数据存储不安全等问题提供了解决方案。

## 区块链运作的核心技术

**1.区块链的链接**

区块链即由一个个区块链组成的链。每个区块分位区块头、区块体（含交易数据）两个部分。区块头包括用来实现区块链接的前一区块的哈希值（又称散列值）和用于计算挖矿难度的随机数。前一区块的哈希值实际是上一区块头部的哈希值，而计算随机数规则决定了哪个矿工可以获得记录区块的权力。
![images](https://github.com/WangBeijing/webBlog/blob/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/images/1311538396716.jpg?raw=true)

**2.共识机制**

区块链的共识机制目前主要4类：PoW、PsS、DPoS、分布式一致性算法。

（1）PoW工作量证明
（2）PoS权益证明
（3）DPoS股份授权证明
（4）分布式一致性算法
**3.解锁脚本**

脚本是区块链上实现自动验证、自动执行合约的重要技术。脚本类似一套规则，它约束着接收对方怎样才能花掉这个输出上锁定的资产。

交易的合法性验证也依赖脚本。目前它依赖于两类脚本：锁定脚本与解锁脚本。比特币的脚本目前常用的主要分为两种，一种是普通的P2PKH即支付给公钥的哈希地址，接收方只需要使用地址对应的私钥对该输出进行签名，即可花掉该输出。另一类是P2SH即支付脚本哈希。

脚本的机制对于区块链来说非常重要，它类似于区块链技术提供的一个扩展接口，任何人都可以基于这个接口开发基于区块链技术的应用，比如智能合约的功能。脚本机制也让区块链技术作为一项底层协议成为可能。未来很多基于区块链的颠覆性应用，都有可能通过区块链的脚本语言来完成。

**4.交易规则**
区块链的交易就是构成区块的基本单位，也是区块链负责记录的实际有效内容。一个区块链交易可以是一次转账，也可是智能合约的部署等其他事物。

就比特币而言，交易即指一次支付转账。对以太坊来说，交易还可能是智能合约的部署。交易规则确定了符合一定语法规则的合约才能被部署在区块链上。

**5.交易优先级**
区块链交易的优先级由区块链协议规则决定。对于比特币而言，交易被区块包含的优先次序由交易广播到网络上的时间和交易额的大小决定。对于以太坊而言，交易的优先级还与交易的发布者愿意支付的交易费用有关。

**6.Merkle证明**
比特币区块链使用了Merkle证明，为的是将交易存储在每一个区块中。使得交易不能被篡改，同时也容易验证交易是否包含一个特定的区块中。

Merkle树的一个重要场景就是快速支付验证，也就是中本聪描述的‘简化支付验证’

**7.RLP**
RLP(递归长度前缀编码)是Ethereum中对象序列化的一个主要编码方式，其目的是对任意嵌套的二进制数据的序列进行编码。

#### 区块链交易流程

以比特币的交易为例，区块链的交易并不是通常意义上的一手交钱一手交货的交易，而是转账。如果每一笔转账都需要构造一笔交易数据会比较笨拙，为了使得价值易于组合与分割，比特币的交易被设计为可以纳入多个输入和输出，即一笔交易可以转账给多个人。从生成到在网络中传播，再到通过工作量证明、整个网络节点验证，最终记录到区块链，就是区块链交易的整个生命周期。整个区块链交易流程如图
![images](https://github.com/WangBeijing/webBlog/blob/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/images/1331538397817.jpg?raw=true)