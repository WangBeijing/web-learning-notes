## 共识算法讲解

分布式系统中，多个主机通过异步通信方式组成网络集群。在这样的一个异步系统中，需要主机之间进行状态复制，以保证每个主机达成一致的状态共识。然而异步系统中，可能出现无法通信的故障主机，而主机的性能可能下降，网络可能拥塞，这些可能导致错误信息在系统内传播。因此需要在默认不可靠的异步网络中定义容错协议，以确保各主机达成安全可靠的状态共识。

利用区块链构造基于互联网的去中心化账本，需要解决的首要问题是如何实现不同账本节点上的账本数据的一致性和正确性。这就需要借鉴已有的分布式系统中实现状态共识的算法，确定网络中选择记账节点的机制，以及如何保障账本数据在全网中形成正确、一致的共识。

分布式系统共识算法是区块链共识算法的基础

#### 拜占庭容错技术

拜占庭容错技术是一类分布式计算领域的容错技术。拜占庭假设是对现实世界的模型化，由于硬件错误、网络拥塞或中断以及遭到恶意攻击等原因，计算机和网络可能出现不可预料的行为。拜占庭容错技术被设计用来处理这些异常行为，并满足所要解决的问题的规范要求。

##### 拜占庭将军问题
共识算法的核心是在正常的节点间形成对网络状态的共识。

分布式系统不能依靠同步通信，否则性能和效率将非常低。因此寻找一种实用的解决拜占庭将军问题的算法一直是分布式计算领域的一个重要问题。

分布式计算中有关拜占庭缺陷和故障的两个定义：
- 定义1：拜占庭缺陷：任何观察者从不同角度看，表现出不同症状的缺陷
- 定义2：拜占庭故障：在需要共识的系统中由于拜占庭缺陷导致丧失系统服务

在分布式系统中，不是所有的缺陷或故障都能称作拜占庭缺陷或故障。像死机、丢消息等缺陷或故障不能算为拜占庭缺陷或故障。拜占庭缺陷或故障是最严重缺陷或故障，拜占庭缺陷有不可预测、任意性的缺陷。

在一个有拜占庭缺陷存在的分布式系统中，所有的进程都有一个初始值。在这种情况下，共识问题（Consensus Problem），就是要寻找一个算法和协议，使得该协议满足一下三个属性：
- 1）一致性
- 2）正确性
- 3)可结束性

根据Fischer-Lynch-Paterson的理论，在异步通信的分布式系统中，只要有一个拜占庭缺陷的进程，就不可能找到一个共识算法，可同时满足上述要求的一致性、正确性和可结束性要求。在实际情况下，根据不同的假设条件，有很多不同的共识算法被设计出来。这些算法各有优势和局限。算法的假设条件有以下集中情况：
- 1）故障模型：非拜占庭故障/拜占庭故障
- 2）通信类型：同步/异步
- 3）通信网络连接:节点间直连数
- 4）信息发送者身份：实名/匿名
- 5）通信通道稳定性：通道可靠/不可靠
- 6）消息认证性：认证消息/非认证消息

在区块链网络中，由于应用场景的不同，所涉及的目标各异，不同的区块链系统采用了不同的共识算法。一般来说，在私有链和联盟链情况下，对一致性、正确性有很强的要求。一般来说要采用强一致性的共识算法。而在公有链情况下，对一致性和正确性通常没法做到百分之百，通常采用最终一致性的共识算法。

#### 拜占庭容错系统

参与共识记账的每一个记账节点相当于将军，节点之间的消息传递相当于信使，某些节点可能由于各种原因而产生错误的信息并传达给其他节点。通常，这些发生故障节点被称为拜占庭节点，而正常的节点即为非拜占庭节点。

#### 实用的拜占庭容错系统

原始的拜占庭容错系统由于需要展示其理论上的可行性而缺乏实用性。另外，还需要额外的时钟同步机制支持，算法的复杂度也是节点增加而指数级增加。实用拜占庭容错系统，降低了拜占庭协议的运行复杂度，从指数级别降低到多项式级别，使拜占庭协议在分布式系统中应用成为可能。

PBFT是一类状态机拜占庭系统，要求共同维护一个状态，所有节点采取的行动一致，包括一致性协议、检查点协议和视图更换协议。主要关注系统日常运行的一致性协议。

PBFT在很多场景都用应用，在区块链场景中，一般适合于强一致性有要求的私有链和联盟链场景。例如，在IBM主导的区块链超级账本项目总，PBFT是一个可选的共识协议。

#### Raft协议
在Hyperledger的Fabric项目中，共识模块被设计成可插拔的模块，支持PBFT、Raft等共识算法。

Raft最初是一个用于管理复制日志的共识算法，它是一个为真是世界应用建立的协议，主要注重协议的落地性和可理解性。Raft是在非拜占庭故障下达成共识的强一致性

**1.Raft基础**

一个Raft集群包含5个服务器，允许系统有两个故障服务器。每个服务器处于3个状态之一：leader、follower货candidate.正常操作状态下，仅有一个leader，其他的服务器均为follower。follower是被动的，不会对自身发出请求而是对来自leader和candidate的请求做出响应。leader处理所有的客户端请求。condidate状态用来选举leader。

**2.leader选举**

**3.记账过程**

介绍了分布式系统中的常用共识算法。从介绍拜占庭将军问题开始，介绍了拜占庭容错系统、状态机拜占庭协议、实用拜占庭容错协议和Raft。其中拜占庭容错协议和Raft是联盟链和私有链上常用的共识算法。

而公共链的共识机制一般采用工作量证明(POW)和权益证明（POS）算法。

### PoW机制

比特币系统的重要概念是一个基于互联网的去中心化账本，即区块链，每个区块相当于账本页，区块中记录的信息主体，即为相应的交易内容。账本内容的唯一性要求记账行为是中心化的行为，然而，中心化所引发的单点失败，可能导致整个系统面临危机甚至崩溃。去中心记账可以克服中心化账本的弱点，但同时也会带来记账行为的一致性问题。

从去中心化账本系统的角度看，每个加入这个系统的节点都要保存一份完整的账本，但每个节点却不能同时记账，因为节点处于不同环境，接收到不同信息，如果同时记账的话，必然会导致账本的不一致，造成混乱。因此，需要有共识来达成哪个节点有权记账。比特币区块链通过竞争记账的方式解决去中心化的记账系统的一致性问题。

比特币系统设计了以每个节点的计算能力即‘算力’来竞争记账权的机制。在一个去中心化的系统中，谁有权判定竞争结果呢？比特币系统是通过一个称为‘工作量证明’的机制完成的。

简单地说，PoW就是一份确认工作端做过一定量工作的证明。PoW系统的主要特征是计算的不对称性。工作端需要做一定难度的工作得出一个结果，验证方却很容易通过来检查工作端是不是做了相应的工作。

比特币网络的任何一个节点，如果想生存一个新的区块并写入区块链，必须解出比特币网络出的PoW问题。这道题关键的3个要素是工作量证明函数、区块及难度值。工作量证明函数是这道题的计算方法，区块决定了这道题的输入数据，难度值决定了这道题的所需要的计算量。

**1.工作量证明函数**
**2.区块**
**3.难度值**














**PoW的过程**

比特币PoW的过程，可以简单理解成就是将不同的nonce值作为输入，尝试进行SHA256哈希运算，找出满足给定数量前导0的哈希值得过程。而要求的前导0的个数越多，代表难度越大。

比特币的工作量证明，就是俗称‘挖矿’所做的主要工作。理解工作量证明机制，将为我们进一步接力比特币区块链的共识机制奠定基础

### 基于PoW的共识记账
以比特币网络的共识记账为例，来说明基于PoW的共识记账过程。
- 1）客户端产生新的交易，向全网进行广播要求对交易进行记账；
- 2）每一个记账节点一旦收到这个请求，将收到的交易信息纳入一个区块中；
- 3）每个节点都通过PoW过程，尝试在自己的区块中找到一个具有足够难度的工作量证明；
- 4）当某个节点找到了一个工作量证明，它就向全网进行广播；
- 5）当且仅当包含在该区块中的所有交易都是有效的且之前未存在过的，其他节点才认同该区块的有效性；
- 6）其他节点表示它们接受该区块，而表示接受的方法则是在跟随该区块的末尾，制造新的区块以延长该链条，而将被接受区块的随机哈希值视为先于新区块的随机哈希值。

通过上述的记账过程，客户端所要求记录的交易信息被写入了各个记账节点的区块链中，形成了一个分布式的高概率的一致账本。

**关于比特币PoW能否解决拜占庭将军的问题**

### PoS机制
PoW背后的基本概念很简单：工作端提交已知难于计算但易于验证的计算结果，而其他任何人都能够通过验证这个答案就确信工作端为了求得结果已经完成了量相当大的计算工作。然而PoW机制存在明显的弊端。一方面，PoW的前提是，节点和算力是均匀分布的，因为通过CPU的计算能力来进行投票，拥有钱包（节点）数和算力值应该是大致匹配的，然而随着人们将CPU挖矿逐渐升级到GPU、FPGA，直至ASIC矿机挖矿，节点数和算力值也渐渐失配。另一方面，PoW太浪费了。比特币网络每秒可完成数百万亿次SHA256计算，但这些计算除了使恶意攻击者不能轻易地伪装成几百万个节点和打垮比特币网络，并没有更多实际或科学价值。当然，相对于允许世界上任何一个人在瞬间就能通过去中心化和半匿名的全球货币网络，给其他人几乎没有手续费地转账所带来的巨大好处，它的浪费也许只算是很小的代价。

有鉴于此，人们提出了一些工作量证明的替代者。权益证明（Proof of Stake, PoS）就是其中的一种方法。

权益证明要求用户证明拥有某些数量的货币（即对货币的权益），点点币（Peercoin）是首先采用权益证明的货币，尽管它依然使用工作量证明挖矿。

**1.PoS的应用**
点点币

权益证明必须采用某种方法定义任意区块链中的下一合法区块，依据账户结余来选择将导致中心化，例如单个首富成员可能会拥有长久的优势。为此，人们还设计了其他不同的方法来选择下一合法区块。

**2.随机区块选择**

NXT币和黑币采用随机方法预测下一合法区块，使用公式查找与权益大小结合的最小哈希值。由于权益公开，每个节点都可以合理的准确度预计哪个账户有权建立区块

**3.基于权益速度的选择**

瑞迪币引入权益速度证明，即鼓励钱币的流动而非囤积。通过给币领引入指数衰减函数，使得1币的币领不会超过2币月

### DPoS机制

PoW机制和PoS机制虽然都能有效地解决记账行为的一致性共识问题，但是现有的比特币PoW机制纯粹依赖算力，导致专业从事挖矿的矿工群体似乎已和比特币社区完全分隔，某些矿池的巨大算力俨然成为另一个中心，这与比特币的去中心化思想相冲突。PoS机制虽然考虑到了PoW的不足，但依据权益结余来选择，会导致首富账户的权力更大，有可能支配记账权。股份授权证明机制（Delegated Proof of Stake, DPoS）的出现正是基于解决PoW机制和PoS机制的这类不足。

比特股（Bitshare）是一类采用DPoS机制的密码货币，它期望通过引入一个技术民主层来减少中心化的负面影响。

比特股引入了见证人这个概念，见证人可以生成区块，每一个持有比特股的人都可以投票选举见证人。得到总同意票数中的前N个（N通常定义为101）候选者可以当选为见证人，当选见证人的个数（N）需满足：至少一半的参与投票者相信N已经充分地去中心化

DPoS的这种设计使得区块的生成更为快速，也更加节能。

### Ripple共识算法

##### 1.Ripple的网络结构
Ripple（瑞波）是一种基于互联网的开源支付协议，可以实现去中心化的货币兑换、支付与清算功能。在Ripple的网络中，交易由客户端（应用）发起，经过追踪节点（tracking node）或验证节点（validating node）把交易广播到整个网络中。追踪节点的主要功能是分发交易信息以及响应客户端的账本请求。验证节点除包含追踪节点的所有功能外，还能够通过共识协议，在账本中增加新的账本实例数据。
![images](1561538546003.jpg)

##### 2.Ripple共识算法
Ripple的共识达成发生在验证节点之间，每个验证节点都预先配置了一份可信任节点名单，称为UNL（Unique Node List）。在名单上的节点可对交易达成进行投票。每隔几秒，Ripple网络将进行如下共识过程：
- 1）每个验证节点会不断收到从网络发送过来的交易，通过与本地账本数据验证后，不合法的交易直接丢弃，合法的交易将汇总成交易候选集（candidate set）。交易候选集里面还包括之前共识过程无法确认而遗留下来的交易。
- 2）每个验证节点把自己的交易候选集作为提案发送给其他验证节点。
- 3）验证节点在收到其他节点发来的提案后，如果不是来自UNL上的节点，则忽略该提案；如果是来自UNL上的节点，就会对比提案中的交易和本地的交易候选集，如果有相同的交易，该交易就获得一票。在一定时间内，当交易获得超过50%的票数时，则该交易进入下一轮。没有超过50%的交易，将留待下一次共识过程去确认。
- 4）验证节点把超过50%票数的交易作为提案发给其他节点，同时提高所需票数的阈值到60%，重复步骤3）、步骤4），直到阈值达到80%。
- 5）验证节点把经过80%UNL节点确认的交易正式写入本地的账本数据中，称为最后关闭账本（Last Closed Ledger），即账本最后（最新）的状态。
![images](1571538546033.jpg)

在Ripple的共识算法中，参与投票节点的身份是事先知道的，因此，算法的效率比PoW等匿名共识算法要高效，交易的确认时间只需几秒钟。当然，这点也决定了该共识算法只适合于权限链（Permissioned chain）的场景。Ripple共识算法的拜占庭容错（BFT）能力为（n-1）/5，即可以容忍整个网络中20%的节点出现拜占庭错误而不影响正确的共识。

### 小蚁共识机制

小蚁是基于区块链技术，将实体世界的资产和权益进行数字化，通过点对点网络进行登记发行、转让交易、清算交割等金融业务的去中心化网络协议[插图]。小蚁可以被用于股权众筹、P2P网贷、数字资产管理、智能合约等领域。

小蚁共识机制使得运行小蚁协议的各节点能够对当前区块链状态达成一致意见。通过股权持有人投票选举，来决定记账人及其数量；被选出的记账人完成每个区块内容的共识，决定其中所应包含的交易。
小蚁的记账机制被称为中性记账。PoW/PoS/DPoS解决谁有记账权的问题，而中性记账则侧重于解决如何限制记账人权力的问题。在中性记账的共识机制下，记账人只有选择是否参与的权力，而不能改变交易数据，不能人为排除某笔交易，也不能人为对交易进行排序。

> 小结：本章主要讨论共识机制。如何在分布式系统中高效地达成共识是分布式计算领域的重要研究问题，经典的拜占庭容错技术能够在拜占庭服务器不超过1/3以及同步通信的情况下，达成拜占庭系统中的共识。而在异步通信情况下，理论上只要有一个拜占庭故障服务器，就无法在全网中达成一致的共识。为了解决实际的分布式一致性问题，很多实用的共识算法被设计了出来。这些算法有不同的假设条件，具有不同的优点和局限。本章重点介绍了适应于私有链和联盟链环境的实用拜占庭容错（PBFT）协议，以及针对非拜占庭故障的Raft共识算法。
> 早期的比特币区块链采用高度依赖节点算力的PoW机制，来保证比特币网络分布式记账的一致性，之后又出现了PoS和DPoS等共识机制。除这3类主流共识机制外，实际区块链应用中也衍生出了多个变种机制。这些共识机制各有优劣。例如PoW共识机制在安全性和公平性上比较有优势，也依靠其先发优势已经形成成熟的挖矿产业链，但也因为其对能源的消耗而饱受诟病。而新兴的机制，如PoS和DPoS等则更为环保和高效，但在安全性和公平性方面比不上PoW机制。
> 一般来说，PoW和PoS机制比较适合公共链环境，而PBFT和Raft则比较适合联盟链和私有链的分布式环境。比特币的PoW机制是一种概念性的拜占庭协议，能在一定程度上解决拜占庭问题。而PoS等其他机制，目前并没有严格的分析证明其在拜占庭协议方面的属性。