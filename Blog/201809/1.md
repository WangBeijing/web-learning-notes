
#### 大纲
- 1.前端如何生成
- 2.前端生成弊端
- 3.如何优化
- 4.node中间件生成
- 5.node生成图片流程
- 6.注意事项
- 7.如何优化

#### 产品场景
小程序是微信生态圈核心产品，提供识别小程序二维码，加上生成图片功能，能够让用于主动与好友分享，或者在群朋友圈传播海报，能有效提高产品用户活跃度，增加PV。

海报包括文案、图片、带参数小程序二维码

#### 1.前端生成图片

**前端如何生成图片？**
- html2canvas
- canvas-wx.canvasToTempFilePath

考虑到小程序目前对第三方库支持不友好，并且小程序官方提供原生Canvas API，可以调用wx.canvasToTempFilePath将canvas画布生成图片


#### 2.前端生成弊端
- 2.1下载资源到本地合成图片
- 2.2手机可能会在弱网环境，影响资源下载

需要将制定图片定位到canvas画布上，但由于微信小程序限制，必须要将图片下载到本地

**使用JS实现图片压缩**
```
// 核心API是canvas的drawImage()
context.drawImage(img, dx, dy, dWidth, dHeight)
```
**1.canvas.toDataURL()可以把画布转成base64格式信息图像信息，纯字符**
```
canvas.toDataURL(mimeType, qualityArgument)
```
`mimeType`表示`canvas`导出来的`base64`图片的类型，默认是`png`格式，也即是默认值是`'image/png'`，我们也可以指定为jpg格式`'image/jpeg'`或者webp等格式。file对象中的`file.type`就是文件的`mimeTye`类型，在转换时候正好可以直接拿来用（如果有file对象）。

`qualityArgument`表示导出的图片质量，只要导出为jpg和webp格式的时候此参数才有效果，默认值是0.92，是一个比较合理的图片质量输出参数，通常情况下，我们无需再设定。



#### 3.如何优化
##### 如何解决上述问题
1.使用Promise.all()等待N张图片下载完成后，再进行绘制

2.可以将固定图片使用canvas转成base64存储到storage中，每次绘制直接从缓存中读取base64转成图片，再进行绘制。检查缓存中是否存在，不存在的话重新下载图片

> 这样就有效避免每次生成海报下载图片素材流量浪费，又可以避免弱网环境影响资源下载导致，图片生成失败。当然也可以使用资源预下载等技术手段进行优化

虽然在小程序端实现了生成图片功能，但是依然不太稳定，所以考虑将生成图片功能放到Node中间层实现。

#### 4.Node实现生成图片功能

使用canvas库

#### 5.Node生成图片流程

- 从前端获取参数，调用小程序api生成带参数的二维码

- 绘图
- 上传oss
- 将图片链接发送给前端

#### 6.注意事项

- 从前端获取屏幕宽高，生成自适应屏幕图片

#### 7.如何优化


