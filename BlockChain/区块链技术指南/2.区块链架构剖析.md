## 区块链架构剖析

区块链源于支持BitCoin虚拟货币系统的底层基础架构，在支撑BitCoin平稳运行三四年后，以其独特的去中心化架构逐渐吸引IT业界的关注，使得业界的关注点逐渐从虚拟货币转移到区块链平台上，并被任务是目前呼声最高的下一代互联网————‘价值互联网’的颠覆性技术

#### 基本定义

**定义1：区块链**
- 1）一个分布式的链接账本，每个账本就是一个‘区块’
- 2）基于分布式的共识算法来决定记账者
- 3）账本内交易由密码学签名和哈希算法保证不可篡改
- 4）账本按生产时间顺序链接，当前账本含有上一个账本的哈希值，账本间的链接保证不可篡改
- 5）所有交易在账本中可追溯

**定义2：分布式**

分布式是一种计算模式，指在一个网络中，各节点通过相互传送消息来通信和协调行动，以求达到一个共同目标。在区块链中，分布式包括‘完全去中心’、‘部分去中心’、‘部分中心’3种模式，分别对应区块链的3种部署模式：‘公有链’‘联盟链’和‘私有链’。分布式意味着在区块链网络中不存在一个中心节点，该节点负责生产、修改、保管所有账本。

**定义3：完全去中心**
一种网络的架构模式，在该模式下网络没有拥有者，完全对外开放。网络中每个节点都可选择拥有相同的权限。在完全去中心的区块链网络上，所有节点都可以读写区块链数据，都可作为记账的候选节点参与共识流程，有机会参与账本的生成和记账。

**定义4：部分去中心**
一种网络的架构模式，在该模式下网络属于一个联盟共同所有，网络只对联盟成员开放。网络中每个节点被赋予不同权限。在“部分去中心”的区块链网络上，节点根据所赋予权限读写区块链数据，参与共识流程以及参与账本的生成和记账。

**定义5：部分中心**
一种网络的架构模式，在该模式下网络属于一个所有者，网络只对所有者内部成员开放。网络中每个节点被赋予不同权限。在“部分中心”的区块链网络上，节点根据所有者赋予的权限读写区块链数据，参与共识流程以及参与账本的生成和记账。

**定义6：架构**
架构有两个层面的涵义。一个是静态层面的，主要是勾画系边界、结构、组成的组件以及组件之间的关联关系；另一个是动态层面，主要是规范组件的行为及组件之间的交互协议。根据一个IT系统的架构，可以界定该系统的功能特性和一些非功能特性。

架构设计要考虑不断变化和恒久不变的两方面。

一个有长久生命力的系统都有一个设计高明的架构，其精髓在于架构能支持系统功能的变化、发展、演化，允许系统功能不断变化，也就是架构必须提供的灵活性。

而系统对易用性、安全性、稳定性和性能却应该是恒久不变的，因此IT架构的设计必须强调非功能特性，其中开放性、可扩展性、可移植性、可维护性、灵活性、安全性、性能（响应时间、吞吐率、并发数等）最为重要。比特币出现短短几年后，从中衍生出多种代币和应用，可以窥见其架构设计的安全、巧妙、灵活和可扩展性。

### 区块链1.0架构：比特币区块链

区块链1.0的典型应用是比特币应用，比特币是第一个解决‘双花’问题的去中心化虚拟货币系统。

比特币架构总体上分位两部分，一部分是前端，包括钱包（Wallet）或图形化界面；另一个部分是运行在每个节点的后台程序，包括挖矿、区块链管理、脚本引擎以及网络管理等功能。
![Images](1411538441588.jpg)

#### 比特币前端

**1.钱包**

钱包保存用户的私钥数据库，并管理用户的余额，提供比特币交易（支付、转账）功能。

钱包分为两种：非决定性钱包和决定性钱包。
- 1）非决定性钱包：该类钱包直接保存私钥，私钥数据保存在BerkeleyDB上
- 2）决定性钱包：目前建议使用的一种钱包。该类钱包所有的私钥都由一个私钥种子（Seed）通过单向哈希算法生成，隐藏备份该类钱包非常容易，只要备份私钥种子，就可以利用种子一次性恢复所有的私钥

钱包从部署场景来说，分位4种：移动钱包、桌面钱包、互联网钱包、以及纸钱包。

**2.HTTP/JSON RPC API**

比特币提供了HTTP/JSON RPC API接口，供外部通过接口控制比特币节点。

**3命令行工具bitcoin-cli**

bitcoin-cli提供一个命令行工具来控制比特币节点。该命令行工具通过JSON RPC API接口访问比特币后台bitcoind。用户可以通过发命令来完成比特币的各项功能，例如查询余额、支付、转账等。

**4.比特币浏览器**

比特币提供一个跨平台的C++ libbitcoin库，该库支持比特币全节点服务端和浏览器作为客户端命令行工具。

**5.图形开发工具(QT)**

比特币核心是比特币使用最广的客户端，它是使用c++开源用户界面开发工具Qt所开发桌面客户端。Qt是一个跨平台的c++图形用户界面应用程序框架。

#### 比特币节点后端

比特币节点后台负责参与比特币网络的通信互联，维护区块链，验证区块、交易，广播、转播传递区块交易信息。比特币的后台程序主要是由bitcoind，以及挖矿节点程序构成。比特币核心bitcoin-qt实际上是包含前后端（除挖矿功能以外）的一体化节点。下面简单介绍比特币后端组件的功能。

**1.区块链管理**
区块链管理涉及初始区块链下载、连接区块、断开区块、校验区块和保存区块，以及发现最长联调的顶区块。区块链管理的代码逻辑都在main.cpp程序中实现。

- （1）下载区块链
- （2）接收区块链
- （3）区块链验证
- （4）重组区块链

**2.区块验证**

交易验证模块会基于以下条件检查收到的比特币交易是否合规：
....
...
..
.

**3.内存池管理**

比特币内存池管理也就是交易池管理。

**4.邻节点管理**

当一个新比特币节点做初始启动的时候，它需要发现网络中的其他节点，并与至少一个节点链接。

**5.共识管理**

比特币里广义的共识管理（Consensus）应该包括挖矿、区块验证和交易验证规则。但这些功能实现目前分散在不同的程序中。由于比特币的关键是在陌生P2P环境建立共识机制，因此共识管理至关重要。目前比特币的开源社区也意识到共识管理的模块化非常重要，因为不同的比特币实现可以简单重用共识管理模块，以保障验证规则的一致性。未来共识模块将从比特币核心中分离出去，作为独立的模块。这样未来共识逻辑的改变也不会对比特币核心带来影响。目前在比特币0.12.0版本中，一部分共识管理的代码已经移到consensus子目录。可以预见，未来更多的共识管理逻辑将移到该子目录，成为可插拔的共识模块。
比特币的共识管理必须支持前向兼容，即使过去版本有缺陷（bug）也要保持，否则比特币网络会出现分叉。
目前在consensus子目录的共识程序有consensus.*、merkle.*、params.*和validation.*。

**6.规则管理**

比特币的共识规则是所有节点都必须遵守的规则。而每个节点可以采用一些共识规则以外的个性化规则。

**7.密码模块**

密码模块（Crypto）主要是处理比特币地址，采用RIMEMD和SHA-256算法以及Base-58编码生成比特币地址。

Base58Check的校验码对地址信息进行双重SHA256哈希处理，并取前4位做校验码，加在比特币地址的后面，因此比特币地址带有校验信息，可以防止人为错误。

**8.签名模块**

比特币采用椭圆曲线数字签名算法（ECDSA）来实现数字签名以及生产公钥。

**9脚本引擎**

比特币的脚本语言是一种专门设计的、与‘Forth’类似的、基于堆栈的变成脚本语言。

**10.挖矿**

比特币核心不带挖矿（mining）功能

**11.HTTP/JSON RPC服务端**

比特币在启动的时候，初始化程序init.cpp会启动HTTP/JSON RPC服务端的线程组。

**12.Berkeley DB和LevelDB数据库**

比特币用Berkele DB做钱包数据库。

**13.P2P网络管理**

P2P网络管理的代码主要是在P2P网络上实现和其他邻节点的通信功能。

**14.ZMQ**

比特币采用Zero MQ作为消息队列管理和消息分发工具。


