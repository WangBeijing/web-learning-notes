### 智能合约简介

#### 什么是智能合约
智能合约是指一种计算机协议，这类协议一旦制定和部署就能实现自我执行（self-executing）和自我验证（self-veri-fying）,而且不在需要人为的干预。

从技术的角度来说，智能合约可以被看做一种计算机程序，这种程序可以自主地执行全部或部分和合约相关的操作，并产生相应的可以被验证的证据，来说明执行合约操作的有效性。

通常来说，智能合约一旦部署成功，就不会再收到人为的干预，从而无法随时修正合约设计中出现的漏洞。

#### 智能合约的优点和面临的风险

**智能合约具有以下优点**
- 高效的实时更新
- 准确执行
- 较低的人为干预风险
- 去中心化的权威
- 较低的运行成本

> 技术的应用要有坚实的理论基础做支撑，那么完全去中心化的智能合约是否已经成熟以及面临攻击如何应对都将成为未来主要探索的课题。

### 以太坊智能合约详解

#### 1.以太坊上的账户
账户是以太坊的核心操作对象，但和比特币以及传统区块链不同，在以太坊上账户被分位两类，一类叫做外部所有账户（Externally Owned Ac-counts, EOS），另一类叫作合约账户。

> 外部所有账户可被简单称为“账户”，这是由于外部所有账户与一般的区块链电子货币的账户（例如，比特币账户）类似，都是人为创建的，能够存取货币，由公钥加密系统加密和分享的账户。不同的是在以太坊上，外部所有账户都有能力创建合约账户，并部署智能合约。总之，在以太坊内部，外部所有账户和合约账户都被统称为状态对象（state objects）,这些对象都具有自己状态，其中外部所有账户的状态体现在其包含多少货币余额，而合约账户既含有货币余额状态还有合约存储状态。这些对象的状态随着每个区块的产生而发生变化。

简而言之，以太坊的基础就是通过区块链技术记录这些状态的变化，通过工作量证明，这些状态变化被大多数用户所认可，从而达成共识。

**1.钥匙文件**

每个账户都通过一对私钥和公钥来确定。每个账户都拥有一个地址，这个地址来自于该账户的公钥的最后20个字节。每一账户的地址和私钥都被编码成一个JSON格式的“钥匙文件”。
 
存储在本地的以太坊账户私钥总是处于加密状态，而加密所使用的密钥就是在账户创建时用户所输入的密码。
```
{
    "address": "",
    "Crypto": {
        "cipher": "",
        "ciphertext": "",
        "cipherparams": {
            "iv": "",

        },
        "kdf": "",
        "kdfparams": {
            "dklen": 32,
            "n": 262144,
            "p": 1,
            "r": 8,
            "salt": ""
        }
    },
    "mac":""
},
"id": ""
```
钥匙文件只存储了以太坊私钥的密文，只有知道用户自己设定的密码才能得到以太坊账户的真正私钥，该私钥用于此账户所有交易的签名。

**2.创建账户**

最普遍使用的是基于Go和C++程序设计语言的客户端（go-ethereum和cpp-ethereum）

通过go-ethereum创建账户十分容易。以Linux操作系统为例，创建一个账户步骤

1）安装好以太坊和go-ethereum，在客户端执行以下命令
```
sudo apt-get install  software-properties-common
sudo apt-get-repository -y ppa:ethereum/ethereum
sudo apt-get update
sudo apt-get install ethereum
```
2)执行geth account new 命令创建账户，并设置密码
```
geth account new 
Your new account is locked with a password. Please give a password. Do not forget this password.
Passphrase
Repeat passhorase:
Address: {............}
```
设置好密码之后，客户端会显示所创建的新账户的地址。

3）执行geth命令，同步已有的所有区块 `geth`

当区块链全部同步好之后，就可以进行挖矿并部署智能合约了。以太坊的开发还开发了拥有图形界面的以太坊钱包（Ethereum Wallet）,方便用户更容易地管理账户和部署智能合约。以太坊在Github上官方网站（https://github.com/ethereum/mist/releases）下载对应的钱包程序。

第一次运行钱包时，用户在所示界面选择同步以太坊的主链还是其公共的测试链（testnet）.在测试链上，用户不需要长时间地挖矿就是很快地获得大量测试用的以太币，并运行测试自己的智能合约。而在主链上，用户则需要花费大量计算资源挖矿才能获得标准的以太币。

在选择好同步的网络之后，用户可以选择是否同步完区块链后再进入主界面。用户可以通过界面上提示创建自己账户，单击add account按钮。账户创建和区块链的同步无关，因此用户可以一边同步一边创建账户。

**3.账户备份**

备份以太坊账户只需要找到相应的以太坊目录即可。根据不同的操作系统，以太坊的文件存储目录如下：
```
Windows: C:\Users\username\appdata\Roaming\Ethereum
Linux: ~/.ethereum
Mac: ~/Library/Ethereum
```

> chaindata文件夹存储着以太坊主链的所有区块，keystore文件夹存储着用户的账户数据，testnet文件夹内有一套完整的用于以太坊测试链文件，其中也含有chaindata和keystore文件夹，存储着测试链上所有区块和用户的账户信息

### 以太币和Gas
#### 1.以太币
以太坊激励机制，鼓励矿工花费计算资源进行挖矿，从而维持以太坊的运行，这一机制就是以太币（Ether）。以太坊上所有的账户管理操作和智能合约的部署都需要支付以太币才能正常运行，因此每个以太坊用户都需要获得并花费以太币。

以太坊的最小货币单位是1wei，其和以太币的兑换率是： 1Ether = 10的18次方wei。每当一个区块被矿工挖出，挖出这一区块的矿工就将获得一定数量的奖励，有两部分组成
- 静态奖励：该矿工可获得5个以太币作为奖励
- 动态奖励：挖出的区块中所有交易的费用归该矿工所有

#### 2.Gas
智能合约一旦部署在以太坊上就无法再被修改。为了防止恶意用户部署无线循环运行的合约，以太坊要求用户为所部署合约的每一步支付费用，这些费用的基础单位就是Gas。因此，Gas就相当于部署和执行智能合约所需要的燃料，这种燃料机制维持着以太坊的经济体系的运行，用户只能通过挖矿或从矿工那里购买以太币来补充燃料。
> 注：Gas并不是以太币单位，而是部署运行智能合约所需的想对花费，可通过燃料价格转化成以太币

Gas相关概念总结如下
- Gas花销：Gas花销是静态的，其在针对某一种操作时是不变的。其目的是保证每种操作所需要的计算资源保持不变
- Gas价格：花费每个Gas所需的以太币的数量。
- Gas费用：Gas价格乘以Gas花销，即合约所需的真是费用，其单位的以太币

### 合约和交易
#### 1.合约账户
以太坊的外部所有账户主要具有以太几个特点：
- 可以存储以太币
- 可以发起交易，其中包括交易以太币和部署运行智能合约
- 用户创建账户密钥，并管理账户
- 不支持智能合约代码

合约账户具有以太特点：
- 可以存储以太币
- 可支持智能合约
- 可响应别的用户或合约执行此智能合约的请求，并返回结果
- 可调用别的智能合约

在以太坊上，所有被记录在区块链内的活动都是由外部所有账户发起的。每当一个合约账户收到一个交易申请，其接受传递而来的参数，并通过运行在每个节点上的以太坊虚拟机执行自身代码。每一笔有效的记录都被记录在区块链上，通过所在区块在整个链的位置记录该交易的时间，整个区块链则反映了所有交易的执行顺序

使用以太坊时，有两个概念需要区分
- 交易（Transaction）:交易是指一个外呼所有账户将一个经过签名的数据包发送到另一个账户的过程，这个过程中产生的账户状态变化将被存储到区块链上
- 消息（message）:以太坊的合约账户有能力向其他合约账户发送“消息”。这里的消息是一个虚拟对象，并不会具体存在以太坊的区块链内，可以将其想象成一个函数调用的过程。

本质上来说，交易和消息是两个非常相似概念。区别在于，消息是由合约账户产生的，交易是由外部所有账户产生的。

#### 2.智能合约的编写
以太坊上的一个智能合约就是一个段可被以太坊虚拟机执行的代码，这些代码以以太坊特有的二进制形式存储在区块链上，并有以太坊虚拟机解释，因此被称为以太坊虚拟机位码（bytecode）

以太坊最大特色就是，以太坊虚拟机的建立使得智能合约的编写变得非常容易，可由高级语言编写，并通过虚拟机转化成位码存储在区块链上。目前来说用于以太坊智能合约开发语言主要有3种，Solidity、Serpent、LLL.
作为最流行的智能合约语言Solidity以其简单易用和高可读性受到以太坊设计者们推荐，目前编译Solidity代码最简单方式是使用在线编译器(https://github.com/ethereum/browser-solidity)

#### 3.智能合约的部署流程
在部署合约时，以太坊虚拟机负责将用户编写的智能合约代码编译成位码。这些位码被存储在区块链上，在需要时通过web3.js javascript API调用，并可用来构建与之交互的web应用。这些api游web3.js库提供，是和以太坊节点建立联系的媒介，其本质是通过JSON-RPC协议与本地的以太坊节点进行通信。JSON-RPC则是一个由JSON格式编码、轻量级的远程过程调用协议，其定义了一些数据结构、规则和接口，可用于网络上绝大多数的数据通信协议（如HTTP）.

总的来说，在以太坊上部署和运行智能合约需要以下几个步骤：
- 1）启动一个以太坊节点（如geth）
- 2)使用智能合约语言编写智能合约（如solidity）
- 3）使用solc编译器将编写好的合约代码转行成以太坊虚拟机位码（如Browser-Based Compiler）
- 4）将编译好的合约代码部署到网上需要消耗用以太币购买的GAS，并且需要合约发起用户使用自己的外部所有账户对需要部署的合约进行签名，通过矿工的确认后，将合约代码存于以太坊的区块链上。在这一步中，用户可获得合约的地址，以及调用合约所需的接口，以便之后使用
- 5）使用web3.js库所提供的JavaScript API接口来调用合约。这一步会消耗以太币，具体消耗值取决于所调用的智能合约

以太坊上的智能合约部署和调用的过程如图
![image](https://github.com/WangBeijing/webBlog/blob/master/images/bushuzhinengheyue001.png?raw=true)