### 以太坊虚拟机

以太坊并不是唯一一个可以在区块链上部署智能合约的平台，但使得以太坊与众不同的重要一个点就是建立在区块链上的以太坊虚拟机。虚拟机在引入使得编写智能合约变得异常容易，高度脚本化的程序设计语言（Solidity）使得普通用户也能轻松地开发自己的智能合约，而不需要太多专业学习。

简单来首，以太坊虚拟机是建立在以太坊区块链上的一个代码运行环境，但虚拟机本身没有存储在区块链内，而是和区块链一样同时存储于各个节点计算机。每个参与以太坊网络中的校验节点都会运行虚拟机，并将其作为区块链有效性校验协议的一部分。每个节点都会对合约的部署和调用进行相同的计算，并存储相同的数据，以确保将最权威的结果记录在区块链内。

以太坊虚拟机的架构实际上市一个简单的堆栈式结构，每个堆栈项目为256位，即虚拟机的位宽256位，其目的是使之能够方便地应用于256位的Keccak散列算法和椭圆曲线计算。堆栈存储是一个基于字段地址的数组，其最大包含1024个元素。

以太坊虚拟机还能处理异常执行，其中包含堆栈溢出和无效指令等。同时，针对GAS不足的异常，虚拟机会立即停止工作，并将报告给交易处理器或运行环境的代理程序，由它们单独处理。

#### 1.GAS的消耗
在以太坊虚拟机内部,GAS的消耗会出现下列3种情况（其中第一种情况最常见）
- 当需要执行特定的内部抽象操作时，例如，运行SHA3散列运算时
- 当进行一个从属的消息调用或合约创建时，例如，执行CREATE、CALL或者CALLCODE操作时
- 当需要增加账户内存使用量时

在账户进行操作时，需要支付费用的账户内存使用量应该是32个字节的整数倍，以保证使用的所有内存都能包括在计费范围内。此外，内存使用的计费机制还有助于激励用户使用较少的内存。当执行账户内存清理操作时，该操作不仅不会消耗任何GAS，还会得到一定数量的内存使用费用的折扣，还会得到一定数量的内存使用费用折扣，以激励用户尽量释放不用的内存。

#### 2.虚拟机运行环境
假设整个以太坊网络的状态为σ，合约运算剩余的GAS为g，那么在整个运行环境中还有许多重要的信息。
- Ia：当前代码的合约地址；
- Io：发起这次合约交易的发起者地址；
- Ip：用户为这次交易设置的Gas价格；
- Id：这次交易的输入数据，该输入的数据结构是一个数组；
- Is：执行这次合约交易的账户地址；
- Iv：合约账户的余额；
- Ib：用于执行虚拟机代码所需的数组；
- IH：目前区块的数据头；
- Iε：目前执行的CALL操作和CREATE操作的数量。

假设以上信息都包含在一个元组I内，系统状态变化的函数是Ξ, σ′为系统运行后的状态，g′为运行后剩余的Gas, s为执行终止（suicide）操作的合约列表，l为记录序列，r为运行后所返还的Gas, o为合约运行后所产生的输出，那么整个以太坊的状态转换可定义为以下公式：
（σ′, g′, s, l, r, o）=Ξ（σ′, g, I）

#### 3.状态转换函数（Ξ）
为了完成整个以太坊系统的状态转化，需要定义状态的转换函数Ξ。在大多数实际情况下，整个系统的状态转换是一个不断地迭代系统临时状态和虚拟机临时状态的过程。迭代的过程需要调用异常检查函数和指令输出函数。迭代的终止由以下两个条件决定：
- 系统状态是否出现异常而使虚拟机停止工作，其中包括GAS不足、指令无效、虚拟机栈堆容量不足等情况，任何正常的系统指令都不会造成异常状态的出现
- 虚拟机的正常状态下停止工作，例如，所有指令执行完毕返回结果

在每一次迭代过程中，智能合约的指令被压入堆栈，虚拟机按堆栈的索引执行指令。每执行一条指令，将支付响应的Gas，直到所有指令执行完毕，堆栈被情况。其中如果遇到异常，虚拟机则停止工作逐层向上返回异常。

#### 4.区块链系统状态的验证
在以太坊虚拟机正确执行所有指令之后，系统的状态得以转换。在以太坊上，对于交易记录的信任建立在对最权威区块链的信任的基础上。以太坊上最权威的区块链是在一个树结构中从根节点（root）到叶子节点（leaf）的路径。实际情况当中，最权威的区块链是由从根节点(即区块链)到某个叶子节点（即新生区块链）间最长路径来决定的。这条路径越长，就意味着这条路径上所消耗的计算资源越多，因而由于工作量证明，说明这条区块链是最权威的，能够得到所有用户的认可。

每产生一个新的有效区块，以太坊系统需要以下几个步骤才能将该区块加入权威区块链上。
- 1）验证该新区块链的ommer区块的有效性
- 2）验证该新区块中所包含的交易的有效性，即所有交易所花费的GAS是否与该区块链中所标记的GAS花费量一致，并与每笔交易一一对应
- 3）对相应的由于新有效区块的产生而能得到以太币奖励的账户发放奖励，其中包括挖到该区块的矿工账户和包含在该区块内的ommmer区块所属的矿工账户
- 4）验证该新区块链的工作量证明，并确认将新区块链接在权威区块链上，并将整个系统更新到最新状态

### 在以太坊上开发实施智能合约
 
> 前面介绍了智能合约和在以太坊上部署运行智能合约的相关基础知识。现在将通过实例展示如何在以太坊上部署运行一个真正的智能合约。

通常在以太坊上可以通过两种常用的方式部署运行智能合约
- 1.使用图形界面的以太坊钱包
- 2.使用go-ethereum通过交互命令部署智能合约

### 通过以太坊钱包部署智能合约

使用以太坊钱包部署智能合约并不需要太多的操作程序，除了需要使用合约语言编写智能合约之外，不需要编辑任何其他代码。其所有的合约代码部署和调用操作都可以在图形界面下完成，十分方便快捷。

#### 1.部署智能合约
通过以太坊钱包部署智能合约包括以下几个步骤

1）下载最新的以太坊钱包或Mist浏览器。Mist浏览器是未来实现发布浏览调用Dapp的工具，现在还在开发之中，目前版本继承了以太坊钱包，可在Mist浏览器内部使用钱包的所有功能。

2）运行以太坊钱包，按照前面介绍的方法选择想要同步的区块链。为了方便获得以太币进行测试，本节所有智能合约的相关操作都在测试网络（testnet）下进行

3）按照前面介绍的方法创建用户外部所有账户，并等待测试区块链全部同步完成

4）为了测试的方便，假设钱包内已有两个外部所有账户（即MAIN ACCOUNT和ACCOUNT1），每个账户中都有一些测试用的以太币。其当前状态如图所示
![image](https://github.com/WangBeijing/webBlog/blob/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/images/1011538378876.jpg?raw=true)

5）现在创建股权的合约。点击右上角的CONTRACTS按钮进入合约菜单，选择部署智能合约（Deploy contract）,选择发起智能合约的账户（这里由MAIH ACCOUNT发起智能合约），并可在AMOUNT菜单中想将要创建的合约账户支付以太币。这里我们不需要合约账户支付以太币，所以将AMOUNT设置为0.将用Solidity语言编写好的智能合约代码赋值到SOLIDITY CONTRACT SOURCE CODE菜单。其合约代码如下：
```
contract MyToken {
    /＊在合约中使用public关键字定义所有能被别的合约访问的变量＊/
    string public name;
    string public symbol;
    uint8 public decimals;
    /＊建立一个数组存储账户的余额＊/
    mapping (address =＞ uint256) public balanceOf;
    /＊建立一个公共的事件用于用户通知＊/
    event Transfer(address indexed from, address indexed to, uint256 value);
    /＊初始化合约，当合约内的函数名和合约名相同时（MyToken），则该函数是合约的构造函数＊/
    function MyToken(uint256 _supply, string _name, string _symbol, uint8
        _decimals) {
        /＊默认将股权分为10000份，即股权的最小单位是0.01%＊/
        if (_supply ==0) _supply =1000000;
        /＊可自定义股权数量和最小单位＊/
        balanceOf[msg.sender] =_supply;
        /＊定义股权名称＊/
        name =_name;
        /＊设定股权所使用的单位符号，例如%＊/
        symbol =_symbol;
        /＊设定小数位数＊/
        decimals =_decimals;
    }
    /＊创建股权转移函数＊/
    function transfer(address _to, uint256 _value) {
        /＊检验是否有足够的股权＊/
        if (balanceOf[msg.sender] ＜ _value) throw;
        if (balanceOf[_to] + _value ＜ balanceOf[_to]) throw;
        /＊更新股权转让信息＊/
        balanceOf[msg.sender] -=_value;
        balanceOf[_to] +=_value;
        /＊通知用户股权转让成功＊/
        Transfer(msg.sender, _to, _value);
    }
```
6)在SELECT CONTRACT TO DEPLOY菜单中选择要部署的合约（即MY Token）。在CONSTRUCTOR PARAMETERS菜单中输入参数
![images](https://github.com/WangBeijing/webBlog/blob/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/images/1051538379794.jpg?raw=true)
输入参数

7)从下拉菜单中可以看到部署合约的Deploy按钮和希望支付的交易费用，费用越多则该合约确认的越快，反之则越慢。单击Deploy按钮出现确认界面。

用户可在此界面中看到可能需要的交易费数量和当前GAS的价格，在Data菜单下可看见合约的以太坊虚拟机位码。之后单击SEND TRANSACTION部署合约。此时，在WALLETS界面下可看到刚刚发送出的合约正在接受确认。以太坊要求交易必须在12个区块产生之后才能得到最终确认，但只要有一个区块确认了合约，就可以调用合约的函数了（这不代表交易得到最终确认，只是临时确认）。其交易确认状态可从WALLETS界面下看到

![images](https://github.com/WangBeijing/webBlog/blob/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/images/1071538380164.jpg?raw=true)
确认部署合约界面

![images](https://github.com/WangBeijing/webBlog/blob/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/images/1081538380175.jpg?raw=true)
部署合约交易确认状态

当12个区块确认完成时，合约才被真正的保存到区块链中，即部署到以太坊的网络上，并可被调用。

#### 2.调用智能合约

在合约部署完成之后，在钱包CONTRACT菜单下可看到刚刚部署成功的合约（My Share）。部署合约相当于创建了一个合约账户，因此在合约My Share内可以看见返回的合约地址和合约接口（interface）。接口和地址是找到合约并调用合约的必要信息。
![images](https://github.com/WangBeijing/webBlog/blob/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/images/1091538380776.jpg?raw=true)
调用新合约

通过钱包调用合约也十分容易，这是因为以太坊钱包已经给合约接口的所有调用继承在钱包界面内，而不需要用户自己访问合约接口。合约接口实际上市一个JSON文件，定义了参数字段，用来告诉客户端如何和这个合约进行交互

> 注：请保存好合约的地址和接口，以便在任何一个以太坊节点调用合约

单击My Shares合约进入合约界面，可看到所有该合约内部的公共参数和合约内定义的函数。这里我们只定义了transfer函数，它用于将股权分配给其他客户，还定义了一个名为balanceOf数组用来查询客户的股权。
- 查询客户的股权余额只需要将账户的地址输入Balance Of菜单下，就可以看到该账户的股权余额。
- 当需要把股权分配给别的客户时，选择transfer函数，并填入参数，其中包括接受账户地址和要发送的股权数量。
![image](https://github.com/WangBeijing/webBlog/blob/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/images/1101538381384.jpg)
分配股权给ACCOUNT 1账户

在设置好参数之后，单击EXECUTE按钮发送交易。和创建合约时一样，经过12个区块的确认，该交易被写入区块链。此后在My Shares合约界面输入Account 1账户的地址，可以看到数字1000，说明已转移

![images](https://github.com/WangBeijing/webBlog/blob/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/images/1111538381602.jpg?raw=true)
合约交易结果

### 通过控制台部署智能合约

除了使用以太坊钱包外，用户还可以通过web3.js javascript api在控制台命令行上部署调用智能合约

**1.部署智能合约**

在命令行部署智能合约首先确认已经安装了go-ethereum客户端，其具体步骤如下

1）打开一个命令行窗口，运行geth命令同步区块链。由于我们使用测试网进行智能合约的部署，这里需要给geth命令加上参数，执行以下命令：
```
geth --testnet
```
2)打开另一个命令行窗口，执行geth attach命令。这个命令会打开一个JavaScript控制台，通过这个控制可使用web3方法和geth自身的管理API调用部署的智能合约。默认的geth attach命令打开的是附加于标准的以太坊区块链的控制台，则要明确为geth attach命令指明访问的位置，此时需要加入参数，执行以下命令：
```
geth attach ipc:/home/*用户名*/.ethereum/testnet/geth.ipc
```
其中，geth.ipc为以太坊的进行间通信接口，此接口用于测试网节点。同样在以太坊文件系统的主目录下也有一个geth.ipc文件，用于标准以太坊节点。

3）用户在部署合约之前，需要知道自己账户地址和余额。在控制台输入一下命令可看到当前所有外部所有账户：
```
personal.listAccounts
```
4)执行以下命令可以以以太币为单位查询账户的余额：
```
web3.fromWei(eth.getBalance('账户地址'，'ether'))
```
此外，还需要解锁要发起智能合约的账户，解锁需要输入账户创建时，所设置的密码，其命令如下：
```
personal.unlockAccount("账户地址")
```
5)通过控制台部署一个简单的给商品打分的智能合约，其代码如下：
```
contract Rating {
    function setRating(bytes32 _key, uint256 _value) {
        /* 为特定编号的商品打分*/
        ratings[_key] =_value
        /* 显示特定商品的分数*/ 
        mapping(bytes32 => unit256) public ratings;
    }
}
```
为了方便起见，我们将代码放到Solidity语言的在线编译器上进行编译
![image](https://github.com/WangBeijing/webBlog/blob/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/images/1121538383110.jpg)
Solidity在线编译器

编译完成之后，在右侧的菜单栏中将web3 deploy菜单下的全部内容复制到控制台中
![image](https://github.com/WangBeijing/webBlog/blob/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/images/1131538383122.jpg)
在控制台部署智能合约

经过一段时间的确认，控制台提示'Contract mined',则合约被创建成功，并返回合约的地址（address）和此次交易的散列值(transacionHash)，可通过这两个数值在区块链上寻找合约的信息。

#### 2.调用智能合约
在部署合约所使用在控制台窗口下，可直接使用合约名和函数名调用合约。假设一个用户想为1号商品打3分，需要调用rating合约的setRating函数，需要执行以下命令：
```
rating.setRing.sendTransaction(1, 3, {from: eth.accounts[0]})
```
由于用户需要发起一个交易并改变区块链的状态，因此需要用到合约对象的sendTransaction()方法来发起交易。该方法的前几个参数为setRating函数的参数，最后一个参数为发起交易的地址，也就是需要为本次交易支付费用的账户的地址。这里eth. accounts[0]代表钱包内的第1个账户，即基准账户MAIN ACCOUNT。

经过一段时间的确认，该交易被保存到区块链中，此时可使用rating合约中的ratings数组来显示1号商品的打分，其命令如下：
```
rating.ratings(1)
```
这时将会显示3，表示1号商品被打了3分。由于此时并不需要改变区块链系统的状态，因此不需要使用sendTransaction方法，也就不需要支付任何费用。
如果想在其他以太坊节点通过控制台调用合约，则需知道合约的地址和接口。
执行以下命令实例化合约对象：
```
var NewRatingContract =eth.contract(interface).at(“address”)
```
这里，interface的信息可从Solidity在线编辑器上获得，而address在合约部署之后返回得到。之后，使用NewRatingContract.ratings(1)命令就可查找到1号商品的打分。

**小结**
介绍了智能合约、智能合约的应用以及其起源，之后介绍了在以太坊上部署智能合约的基本知识以及背后的原理，接下来介绍了以太坊最大的特色——以太坊虚拟机的相关知识。最后通过实例展示如何用图形界面的以太坊钱包和控制台命令行部署运行智能合约。