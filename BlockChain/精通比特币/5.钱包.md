## 钱包
广义上，钱包是一个应用程序，为用户提供交互界面。钱包控制用户访问权限，管理密钥和地址，跟踪余额以及创建和签名交易。狭义上，即从程序猿的角度，“钱包”是指用于存储和管理用户密钥的数据结构。本章中钱包是私钥的容器，一般是通过结构化文件或简单数据库来实现的。

### 钱包技术概述
一个常见误解是，比特币钱包里包含有比特币。事实上，钱包里含有钥匙。‘钱币’被记录在比特币网络的区块链中。用户通过钱包中的密钥签名交易，从而来控制网络上的钱币。在某种意义上，比特币钱包就是密钥链。

> 比特币钱包只含有密钥，而不是钱币。每个用户有一个包含多个密钥的钱包。钱包只包含私钥/公钥对的密钥链。用户用密钥签名交易，从而证明他们拥有交易输出。钱币以交易输出的形式存储在区块链中。

有两种主要类型的钱包，区别在于它们包含多个密钥是否相互关联。
- 1.非确定性钱包，其中每个密钥都是从随机数独立生成的。密钥彼此无关。这种钱包也被称为“Just a Bunch Of Keys(一堆密钥)”，简称JBOK钱包。
- 2.确定性钱包：其中所有的密钥都是从一个主密钥派生出来，这个主密钥即为 种子(seed)。该类型钱包中所有密钥都相互关联，如果有原始种子，则可以再次生成全部密钥。确定性钱包中使 用了许多不同的密钥推导方法。最常用的推导方法是使用树状结构，称为分级确定性钱包或HD钱包。

确定性钱包由种子衍生创造。为了便于使用，种子被编码为英文单词，也成助记词。

#### 非确定性（随机）钱包
在最早的一批比特币客户端中( Bitcoin Core，现在称作比特币核心客户端)，钱包只是随机生成的私钥集合。这 种类型的钱包被称作零型非确定钱包。

这种钱包现在正在被确定性钱包替换，因为它们难以管理、 备份以及导入。 随机密钥的缺点就是如果你生成很多私钥，你必须保存它们所有的副本。这就意味着这个钱包必须被经常性地备份。

虽然比特币核心客户端包含零型钱包，但比特币的核心开发者并不鼓励大家使用。

非确定性钱包，其含有的随机密钥是个松散的集合。

> 除了简单的测试之外，不要使用非确定性钱包。 它们对于备份和使用来说太麻烦了。 相反，推荐使用基于行 业标准的HD钱包，可以用种子助记词进行备份。

#### 确定性（种子）钱包
确定性，或者‘种子’钱包包含通过使用单项离散函数而可从公共的种子生成的私钥。种子是随机生成的数字。这个数字也包含比如索引号码或者可生成私钥的‘链码’。在确定性钱包中，种子足够恢复所有的已经生成的私钥，所以只用在初始化创建时的一个简单备份就足以搞定。并且种子也足够让钱包导入和导出。这就很容易允许使用者的私钥在钱包之间轻松转移。

#### 分层确定性钱包（HD Wallets）
确定性钱包被开发成更容易从单个“种子”中生成许多密钥。确定性钱包的最高级形式是通过BIP0032标准定义的HD 钱包。HD钱包包含以树状结构衍生的密钥，使得父密钥可以衍生一系列子密钥，每个子密钥又可以衍生出一系列 孙密钥，以此类推，无限衍生。

相比较随机(不确定性)密钥，HD钱包有两个主要的优势。
- 第一，树状结构可以被用来表达额外的组织含义。比 如当一个特定分支的子密钥被用来接收交易收入并且有另一个分支的子密钥用来负责支付花费。不同分支的密钥都 可以被用在企业环境中，这就可以支配不同的分支部门、子公司、具体功能以及会计类别。
- 可以允许使用者去建立一个公共密钥的序列而不需要访问相对应的私钥。这可允许HD 钱包在不安全的服务器中使用或者在每笔交易中发行不同的公共钥匙。公共钥匙不需要被预先加载或者提前衍生， 而在服务器中不需要可用来支付的私钥。

#### 种子和助记词
HD钱包具有管理多个密钥和地址的强大机制。由一系列英文单词生成种子是个标准化的方法，这样易于在钱包中 转移、导出和导入，如果HD钱包与这种方法相结合，将会更加有用。 这些英文单词被称为助记词，标准由BIP-39 定义。 今天，大多数比特币钱包(以及其他加密货币的钱包)使用此标准，并可以使用可互操作的助记词导入和导 出种子进行备份和恢复。

让我们从实际的角度来看这个。 以下哪种种子更容易抄录、阅读、导出以及导入? 

16进制表示的种子: 0C1E24E5917779D297E14D45F14E1A1A

助记词表示的种子: army van defense carry jealous true garbage claim echo media make crunch

#### 钱包最佳实践
由于比特币钱包技术已经成熟，出现了一些常见的行业标准，使得比特币钱包具备广泛互操作，易于使用，安全和灵活的特性。这些常用的标准是:
- 助记码，基于BIP-39
- HD钱包，基于BIP-32
- 多用途HD钱包结构，基于BIP-43
- 多币种和多帐户钱包，基于BIP-44

#### 使用比特币钱包

### 钱包技术细节
深入了解被众多比特币钱包所使用的重要行业标准

#### 助记码词汇
助记码词汇是英文单词序列代表(编码)用作种子对应所确定性钱包的随机数。单词的序列足以重新创建种子，并且从种子那里重新创造钱包以及所有私钥。在首次创建钱包时，带有助记码的，运行确定性钱包的钱包的应用程序 将会向使用者展示一个12至24个词的顺序。单词的顺序就是钱包的备份。它也可以被用来恢复以及重新创造应用 程序相同或者兼容的钱包的密钥。助记码词汇可以让使用者复制钱包更容易一些，因为相比较随机数字顺序来说， 它们更容易地被阅读和正确抄写。

> 助记词经常与“脑钱包”混淆。 他们不一样。主要区别在于脑钱包由用户选择的单词组成，而助记符是由钱包随 机创建的，并呈现给用户。

BIP-39定义了助记符码和种子的创建，在这里描述了九个步骤。为了清除起见，该过程分为两部分：1-6步是创建助记词，7-9步是从助记词到种子。

#### 创建助记词
助记词是由钱包使用BIP-39中定义的标准化过程自动生成的。 钱包从熵源开始，增加校验和，然后将熵映射到单词
列表:

- 1、创建一个128到256位的随机序列(熵)。 
- 2、提出SHA256哈希前几位(熵长/ 32)，就可以创造一个随机序列的校验和。 
- 3、将校验和添加到随机序列的末尾。
- 4、将序列划分为包含11位的不同部分。 
- 5、将每个包含11位部分的值与一个已经预先定义2048个单词的字典做对应。 
- 6、生成的有顺序的单词组就是助记码。
![Images](https://github.com/WangBeijing/webBlog/blob/master/BlockChain/Images/WX20181010-221828.png?raw=true)
展示了熵如何生成助记词

#### 从助记词生成种子
助记词表示长度为128至256位的熵。 通过使用密钥延伸函数PBKDF2，熵被用于导出较长的(512位)种子。将所得的种子用于构建确定性钱包并得到其密钥。

密钥延伸函数有两个参数:助记词和盐。其中盐的目的是增加构建能够进行暴力攻击的查找表的困难度。 

创建助记词之后的7-9步是:
- 7、PBKDF2密钥延伸函数的第一个参数是从步骤6生成的助记符。
- 8、PBKDF2密钥延伸函数的第二个参数是盐。 由字符串常数“助记词”与可选的用户提供的密码字符串连接组成。
- 9、PBKDF2使用HMAC-SHA512算法，使用2048次哈希来延伸助记符和盐参数，产生一个512位的值作为其最终输 出。 这个512位的值就是种子。

![Images](https://github.com/WangBeijing/webBlog/blob/master/BlockChain/Images/WX20181010-222358.png?raw=true)

> 密钥延伸函数，使用2048次哈希是一种非常有效的保护，可以防止对助记词或密码短语的暴力攻击。 它使得 攻击尝试非常昂贵(从计算的角度)，需要尝试超过几千个密码和助记符组合，而这样可能产生的种子的数量是巨 大的(2^512)。

#### BIP-39中的可选密码短语
BIP-39标准允许在推导种子时使用可选的密码短语。如果没有使用密码短语，助记词是用由常量字符串“助记词”构 成的盐进行延伸，从任何给定的助记词产生一个特定的512位种子。 如果使用密码短语，密钥延伸函数使用同样的 助记词也会产生不同的种子。

可选密码短语带来两个重要功能:

(存储在大脑中的)密码短语成为第二个因素，使得助记词不能单独使用，避免了助记词备份盗取后被利用。

#### 使用助记符代码

### 从种子中创造HD钱包
HD钱包从单个根种子（root seed）中创建，为128到256位的随机数。最常见的是，这种是从助记符产生的。

HD钱包的所有的确定性都衍生自这个根种子。任何兼容HD 钱包的根种子也可重新创造整个HD钱包。所以简单的 转移HD钱包的根种子就让HD钱包中所包含的成千上百万的密钥被复制，储存导出以及导入。 

![Images](https://github.com/WangBeijing/webBlog/blob/master/BlockChain/Images/WX20181010-223514.png?raw=true)
创建主密 钥以及HD钱包的主链代码的过程。

根种子输入到HMAC-SHA512算法中就可以得到一个可用来创造主私钥(m)(master private key(m) )和主链代码 (a master chain code)的哈希。主私钥(m)之后可以通过使用我们在本章先前看到的那个普通椭圆曲线m * G 过程生来成相对应的主公钥(M)。 链代码用于从母密钥中创造子密钥的那个函数中引入熵。

#### 私有子密钥的衍生
分层确定性钱包使用CKD(child key derivation)函数去从母密钥衍生出子密钥。

子密钥衍生函数是基于单项哈希函数。这个函数结合了: 
- 一个母私钥或者公共钥匙(ECDSA未压缩密钥) 
- 一个叫做链码(256 bits)的种子
- 一个索引号(32 bits)

链码是用来给这个过程引入确定性随机数据的，使得索引不能充分衍生其他的子密钥。最初的链码种子(在密码树的根部)是用随机数据构成的，随后链码从各自的母链码中衍生出来。

....

#### 使用衍生的子密钥
子私钥不能从非确定性(随机)密钥中被区分出来。因为衍生函数是单向的，所以子密钥不能被用来发现他们的母 密钥。子密钥也不能用来发现他们的相同层级的姊妹密钥。如果你有第n个子密钥，你不能发现它前面的(第n- 1)或者 后面的子密钥(n+1)或者在同一顺序中的其他子密钥。只有母密钥以及链码才能得到所有的子密钥。

没有子链码的话，子密钥也不能用来衍生出任何孙密钥。你需要同时有子密钥以及对应的链码才能创建一个新的分
支来衍生出孙密钥。

那子私钥自己可被用做什么呢?它可以用来做公钥和比特币地址。之后它就可以被用在那个地址来签署交易和支付任何东西。

> 子私钥、对应的公钥以及比特币地址都不能从随机创造的密钥和地址中被区分出来。事实是它们所在的序列， 在创造他们的HD钱包函数之外是不可见的。一旦被创造出来，它们就和“正常”密钥一样运行了。

#### 扩展密钥
密钥衍生函数可以被用来创造密钥树上任何层级的子密钥。这只需要三个输入量:一个密 钥，一个链码以及想要的子密钥的索引。密钥以及链码这两个重要的部分被结合之后，就叫做扩展密钥

扩展密钥可以简单地被储存并且表示为简单的将256位密钥与256位链码所并联的512位序列。有两种扩展密钥。扩 展的私钥是私钥以及链码的结合。它可被用来衍生子私钥(子私钥可以衍生子公钥)。

#### 公共子密钥推导

#### 在网点中使用拓展公钥

#### 硬化子密钥衍生

#### 正常衍生和强化衍生的索引号码

#### HD钱包密钥识别符

#### HD钱包树状结构的导航