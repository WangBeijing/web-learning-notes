介绍一些杂比特币中用来控制资金的所有权的密码学，包括密钥，地址和钱包

### 简介
数字密钥实际上不存储在网络中，而是由用户生成之后，存储在一个叫钱包的文件或简单的数据库中。存储在用户钱包的数字密钥完全独立于比特币协议，可由用户的钱包生成并管理，而无需参考区块链或者访问网络。

大多数比特币交易都需要一个有效的签名才会存储在区块链。只有有效的密钥才能产生有效的数字签名，因此拥有密钥副本就拥有了对该账户的比特币的控制权。

密钥是成对出现的，由一个私钥和一个公钥所组成，被存储在钱包文件内，由比特币钱包软件进行管理。

接下来将介绍密码学并解释在比特币中使用的数学知识，了解密钥如何被产生、存储和管理。回顾用于代表的私钥和公钥、地址和脚本地址的各种编码格式，讲讲解密钥和地址的高级用途：比特币靓号、多重签名以及脚本地址和纸钱包。

#### 公钥加密和加密货币

一些合适的数学函数譬如：素数幂和椭圆曲线乘法，这些数学函数都是不可逆的，就是说很容易向一个方向计算，但不可以向相反方向推倒。基于这些数学函数的密码学，使得生成数字密钥和不可伪造的数字签名成为可能。比特币正式使用椭圆曲线乘法作为其公钥加密基础。

在比特币系统中，用公钥加密创建一个密钥对，用于控制比特币的获取。密钥对包括一个私钥，和由其衍生出的唯一公钥。公钥用于接收比特币，而私钥用于比特币支付时的交易签名。

支付比特币时，比特币的当前所有者需要在交易中提交其公钥和签名。

#### 私钥和公钥

一个比特币钱包中包含一系列的密钥对，每个密钥对包括一个私钥和一个公钥。私钥（K）是一个数字，通常随机选出的。有了私钥，我们就可以使用椭圆曲线乘法这个单向加密函数产生一个公钥（K）。有了公钥(k)就可以使用一个单向加密哈希函数生成比特币地址（A）。如何使用椭圆曲线运算将私钥生成公钥，并最终由公钥生成比特币地址。

为什么使用非对称加密（公钥/私钥）？

为什么在比特币中使用非对称密码术？它不是用于“加密”交易。相反，非对称密码学的有用属性是生成数字签名的能力。可以将私钥应用于交易的数字指纹以生产数字签名。该签名只能由知晓私钥的人生成。但是，访问公钥和交易指纹的任何人都可以使用它们来验证签名。这种非对称密码学的适用性🙆任何人都可以验证每笔交易的每个签名，同事确保只有私钥的所有者可以产生有效签名。

#### 私钥
私钥就是一个随机选出的数字。

生成密钥的第一步也是最重要的异步，是要找到足够安全的熵源，几随机性来源。比特币软件使用操作系统底层的随机数生成器来产生256位熵（随机性）。更准确地说，私钥可以是1和n-1之间的任何数字，其中n是一个常数，并选定义为由比特币所使用的椭圆曲线的阶。要生成这样的一个私钥，我们随机选择一个256位的数字，并检查它是否小于n-1。从变成的角度来看，一般是通过在一个密码学安全的随机源中取出一长串随机字节，对其使用SHA256哈希算法进行运算，这样就方便地产生一个256位的数字。如果运算结果小于n-1,我们就有一个合适的私钥。否则就用另一个随机数再重复一次。

> 警告：不要自己写代码或使用你的编程语言提供的简易生成器来获得一个随机数。使用密码学安全的伪随机数生成器（CSPRNG），并且需要一个来自具有足够熵值的源的种子。

比特币私钥空间的大小是2^256这是一个非常大的数字。用十进制表示的话，大约10^77

要使用比特币核心客户端生成一个新的密钥，可使用getnewaddress命令。出于安全考虑，命令运行后只显示生成的公钥，不显示私钥。如果要bitcoind显示私钥，可以使用dumpprivkey命令。dumpprived命令会把私钥以Base58校验和编码格式显示，这种私钥格式被称为钱包导入格式（WIF, Wallet Import Format）
```
$ bitcoin-cli getnewaddress
1J7mdg5rbQyUHENYdx39WVWK7fsLpEoXZy
$ bitcoin-cli dumpprivkey 1J7mdg5rbQyUHENYdx39WVWK7fsLpEoXZy
KxFC1jmwwCoACiCAWZ3eXa96mBM6tb3TYzGmf6YwgdGWZgawvrtJ
```
dumpprivkey 命令打开钱包提取由 getnewaddress 命令生成的私钥。除非密钥对都存储在钱包里，否则bitcoind 的并不能从公钥得知私钥。 dumpprivkey 命令才有效。

#### 公钥
通过椭圆曲线乘法可以从私钥计算得到公钥，这是不可逆的过程：K=k*G。其中k是私钥，G是被称为生成点的常数点，而K是所得公钥。其反向算法，被称为‘寻找离散对数’--已知公钥k来求出私钥k--是非常困难的，就像去试验所有可能的k值，即暴力搜索。

> 提示：椭圆曲线乘法是密码学家称之为“陷阱门”功能的一种函数:在一个方向(乘法)很容易做，而不可能在相反的 方向(除法)做。 私钥的所有者可以容易地创建公钥，然后与世界共享，知道没有人可以从公钥中反转函数并计算 出私钥。 这个数学技巧成为证明比特币资金所有权的不可伪造和安全的数字签名的基础。

##### 椭圆曲线密码（Elliptic Curve Cryptography）解释
椭圆曲线加密法是一种基于离散对数问题的非对称(或公钥)加密法，可以用对椭圆曲线上的点进行加法或乘法运算来表达。

比特币使用了secp256k1标准所定义的一种特殊的椭圆曲线和一系列数学常数。

在椭圆曲线的数学原理中，有一个点被称为“无穷远点”，这大致对应于0在加法中的作用。计算机中，它有时表示为X=Y=0。给定椭圆曲线上的两个点P1和P2，则椭圆曲线上必定有第三点P3=P1+P2

几何图形中，该第三点P3可以在P1和P2之间画一条线来确定。这条直线恰好与椭圆曲线相交于另外一个地方。此点记为P3'=（x,y）。然后在x轴做翻着获得P3=(x, -y)。

下面是几个可以解释‘穷远点’之存在需要的特殊情况。
- 若 P1和 P2是同一点，P1和P2间的连线则为点P1 的切线。曲线上有且只有一个新的点与该切线相交。该切线的斜率可用微积分求得。即使限制曲线点为两个整数坐标也可求得斜率!
- 在某些情况下(即，如果P1和P2具有相同的x值，但不同的y值)，则切线会完全垂直，在这种情况下，P3 = “无穷远点”。

#### 生成公钥
以一个随机生成的私钥k为起点，我们将其与曲线上预定的生成点G相乘以获得曲线上的另一点，也就是相应的公钥K。生成点是secp256k1的一部分，比特币密钥的生成点都是相同的：

{k=k*G}
其中k是私钥，G是生成点，在该曲线上所得的点K是公钥。因为所有比特币用户的生成点都是相同，一个私钥k乘以G将得到相同的公钥K。k和K之间的关系是固定，但只能单向运算，即从k到K。这就是可以把比特币地址（K的衍生）与任何人共享而不会泄露私钥（k）的原因。

> 因为其中的数学运算是单向的，所以私钥可以转换为公钥，但是公钥不能转换回私钥。

#### 比特币地址
比特币地址是一个由数字和字母组成的字符串，可以与任何想给你比特币的人分享。由公钥生成的比特币地址以数字‘1’开头。

比特币地址可以代表一对公钥和私钥的所有者，也可以代表其它东西，比如会在后面的‘P2SH(Pay-to-Script-Hash)’一节讲到的付款脚本。

比特币地址可由公钥经过单向的加密哈希算法得到。哈希算法是一种单向函数，接收任意长度的输入产生指纹或哈希。加密哈希函数在比特币中被广泛使用：比特币地址、脚本地址以及在挖矿中的工足量证明算法。由公钥生成比特币地址时使用的算法是Secure Hash Algorithm（SHA）和the RACE Integ rity Primitives Evaluation Message Digest (RIPEMD)，具体地说是SHA256和RIPEMD160

以公钥K为输入，计算其SHA256哈希值，并以此结果计算RIPEMD160哈希值，得到一个长度为160位（20字节）的数字：A=RIPEMD160(SHA256(K))

公式中，K是公钥，A是生成比特币地址

> 比特币地址与公钥不同。比特币地址是由公钥经过单向的哈希函数生成的。

通常用户见到的比特币地址是经过‘Base58Check’编码，这种编码使用了58个字符和校验码，提高了可读性、避免歧义并有效防止了在地址转录和输入中产生的错误。

#### Bace58和Bace58Check编码

Base64使用了26个小写字母、26个大写字 母、10个数字以及两个符号(例 如“+”和“/”)，用于在电子邮件这样的基于文本的媒介中传输二进制数据。Base64通常用于编码邮件中的附件。Base58是一种基于文本的二进制编码格式，用在比特币和其它的加密货币中。Base58是Base64编码格式的子 集，同样使用大小写字母和10个数字，但舍弃了一些容易错 读和在特定字体中容易混淆的字符。具体地，Base58 不含Base64中的0(数字0)、O(大写字母o)、l(小写字母 L)、I(大写字母i)，以及“+”和“/”两个字符。简而 言之，Base58就是由不包括(0，O，l，I)的大小写字母和数字组成。

为了增加防止打印和转录错误的安全性，Base58Check是一种常用在比特币中的Base58编码格式，比特币有内置 的检查错误的编码。

为了将数据（数字）转换成Base58Chenck格式，首先我们要对数据添加一个称作‘版本字节’的前缀，这个前缀用来识别编码的数据类型。例如：比特币地址的前缀是0，而私钥编码时前缀是128.

接下来，计算“双哈希”校验和，意味着要对之前的结果(前缀和数据)运行两次SHA256哈希算法: 
checksum = SHA256(SHA256(prefix+data))

在产生的长32个字节的哈希值(两次哈希运算)中，我们只取前4个字节。这4个字节就作为检验错误的代码或者 校验和。校验码会添加到数据之后。

结果由三部分组成:前缀、数据和校验和。这个结果采用之前描述的Base58字母表编码。

在比特币中，大多数需要向用户展示的数据都使用Base58Check编码，可以实现数据压缩，易读而且有错误检验。 Base58Check编码中的版本前缀是用来创造易于辨别的格式，在Base58里的格式在Base58Check编码的有效载荷 的开始包含了明确的属性。这些属性使用户可以 轻松明确被编码的数据的类型以及如何使用它们。例如我们可以看 到他们的不同，Base58Check编码的比特币地址是以1开头的，而Base58Check编码的私钥WIF是以5开头的。

### 密钥的格式

#### 私钥的格式

#### 从Base58Check解码

#### 公钥的格式
公钥也可以用多种不同格式来表示，最重要的是它们分为非压缩格式或压缩格式公钥这两种形式。

##### 压缩格式公钥
引入压缩格式公钥是为了减少比特币交易的字节数，从而可以节省那些运行区块链数据库的节点磁盘空间。

未压缩格式公钥使用04作为前缀，而压缩格式公钥是以02或03作为前缀。

这个压缩格式公钥对应着同样的一个私钥，这意味它是由同样的私钥所生成。但是压缩格式公钥和非压缩格式公钥 看起来不同。更重要的是，如果我们使用双哈希函数(RIPEMD160(SHA256(K)))将压缩格式公钥转化成比特币地 址，得到的地址将会不同于由非压缩格式公钥产生的地址。因为一个私钥可以生成两种不同 格式的公钥——压缩格式和非压缩格式，而这两种格式的公钥可以生成两个不同的比特币地址

压缩格式公钥渐渐成为了各种不同的比特币客户端的默认格式，它可以大大减少交易所需的字节数，同时也让存储 区块链所需的磁盘空间变小。

...

##### 压缩格式私钥

当一个私钥被使用WIF压缩格式导出时，不但没有压缩，而且 比“非压缩格式”私钥长出一个字节。这个多出来的一个字节是私钥被加了后缀01，用以表明该私钥是来自于一个较 新的钱包， 只能被用来生成压缩的公钥。私钥是非压缩的，也不能被压缩。“压缩的私钥”实际上只是表示“用于生 成压缩格式公钥的私钥”，而“非压缩格式私钥”用来表明“用于生成非压缩格式公钥的私钥”。为避免更多误解，应该 只可以说导出格式 是“WIF压缩格式”或者“WIF”，而不能说这个私钥是“压缩”的。

如果一个比特币钱包实现了压缩格式公钥，那么它将会在所有交易中使用该压格式缩公钥。钱包中的私钥将会被用 来在曲线上生成公钥点，这个公钥点将会被压缩。压缩格式公钥然后被用来生成交易中使用的比特币地址。当从一 个实现了压缩格式公钥的新的比特币钱包导出私钥时，钱包导入格式(WIF)将会被修改为WIF压缩格式，该格式 将会在私钥的后面附加一个字节大小的后缀01。最 终的Base58Check编码格式的私钥被称作WIF(“压缩”)私钥， 以字母“K”或“L”开头。而以“5”开头的是从较老的钱包中 以WIF(非压缩)格式导出的私钥。

### 高级密钥和地址

#### 加密私钥
BIP0038提出了一个通用标准，使用一个口令加密私钥并使用Base58Check对加密的私钥进行编码，这样加密的私 钥就可以安全地保存在备份介质里，安全地在钱包间传输，保持密钥在任何可能被暴露情况下的安全性。这个加密 标准使 用了AES，这个标准由NIST建立，并广泛应用于商业和军事应用的数据加密。

BIP0038加密方案是:输入一个比特币私钥，通常使用WIF编码过，base58chek字符串的前缀“5”。此外BIP0038加 密方案需要一个长密码作为口令，通常由多个单词或一段复杂的数字字母字符串组成。BIP0038加密方案的结果是 一个由 base58check编码过的加密私钥，前缀为6P。如果你看到一个6P开头的的密钥，这就意味着该密钥是被加 密过，并需要一个口令来转换(解码)该密钥回到可被用在任何钱包WIF格式的私钥(前缀为5)。许多钱包APP现 在能够识别 BIP0038加密过的私钥，会要求用户提供口令解码并导入密钥。第三方APP，诸如非常好用基于浏览器 的Bit Address ， 可以被用来解码BIP00038的密钥。

#### P2SH(Pay-to-Script Hash)和多重签名
以数字3开头的比特币地址是P2SH地址，有时被错误的称谓多重签名或多重签名地址。他们指定比特币交易中受益人为哈希的脚本，而不是公钥的所有者。

一个P2SH地址从交易脚本中创建，它定义谁能消耗这个交易输出。编码一个P2SH地址涉及使用一个在创建比特币地址用过的双重哈希函数，并且只能应用在脚本而不是公钥：
```
script hash = RIPEMD160(SHA256(script))
```
产生的脚本哈希由Base58Check编码前缀为5的版本、编码后得到开头为3的编码地址。一个P2SH地址例子 

> P2SH不一定是多重签名的交易。虽然P2SH地址通常是代表多重签名，但也可能是编码其他类型的交易脚本。

#### 多重签名地址和P2SH
目前，P2SH函数最常见的实现是多重签名地址脚本。顾名思义，底层脚本需要多个签名来证明所有权，此后才能 消费资金。设计比特币多重签名特性是需要从总共N个密钥中需要M个签名(也被称为“阈值”)，被称为M-N多签 名，其 中M是等于或小于N。